name: release

on:
  push:
    # run only against tags
    tags:
      - '*'

permissions:
  contents: write
  # packages: write
  # issues: write

jobs:
  public:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - run: git fetch --force --tags

    - uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Install mingw-w64 for Windows cross-compilation
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64-x86-64

    - uses: goreleaser/goreleaser-action@v6
      if: matrix.os == 'ubuntu-latest'
      with:
        # either 'goreleaser' (default) or 'goreleaser-pro':
        distribution: goreleaser-pro
        version: "~> v2"
        args: release --clean -f .goreleaser.public.yaml
      env:
        GITHUB_TOKEN: ${{ secrets.GO_RELEASER }}
        FURY_TOKEN: ${{ secrets.FURY_TOKEN }}
        GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}

    - name: Build Windows binary
      if: matrix.os == 'windows-latest'
      run: |
        go build -trimpath -ldflags="-s -w" -o reveald.exe ./cmd/reveald
      env:
        CGO_ENABLED: 1
        GOOS: windows
        GOARCH: amd64
